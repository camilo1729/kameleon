# ### oar_slurm_lustre_esp.yaml Kameleon recipe ###
# This recipe can be used to create a Debian appliance running
# a Lustre kernel and Lustre tools
#
global:
 #
 # Where Kameleon stores tmp files and appliances
 workdir_base: /var/tmp/kameleon
 # 
 # Debian specific
 distrib: debian
 debian_version_name: squeeze
 distrib_repository: http://ftp.fr.debian.org/debian/
 #
 # Lustre specific
 lustre_repository: http://oar.imag.fr/debian/mirrors/pkg-lustre.alioth.debian.org/lustre/
 lustre_g5kutils_repository: http://oar.imag.fr/debian/lustre/
 #
 # Architecture
 #arch: amd64
 #kernel_arch: "amd64"
 arch: i386
 kernel_arch: "686"
 #
 # Extra packages to install on the minimal base system
 extra_packages: "vim less bzip2 openssh-server rsync gnupg locales debian-keyring console-tools mingetty perl e2fsprogs ntp ntpdate lustre-utils lvm2 iozone3 subversion ruby rubygems libyaml-perl libjson-perl mysql-server mysql-client sudo libdbi-perl libdbd-mysql-perl perl-suid taktuk pidentd curl nfs-kernel-server nfs-common munge libmunge2 libmunge-dev build-essential libreadline6-dev gcc python gawk"
 #
 # Network configuration
 network_hostname: kameleon
 # Following variables are used by the "network_config_static" step
 #network_eth0_ip: 129.88.70.251
 #network_eth0_mask: 255.255.255.248
 #network_gateway: 129.88.70.249
 #network_dns: 129.88.30.10
 #network_domain: imag.fr
 #
 # You can start with a "checkpoint_resume" step if you want
 # to start form a pre-built image. The image can be made
 # with the "checkpoint" step.
 checkpoint_file: /var/tmp/lustre_checkpoint.tgz
 # 
 # RJMS specific
 oar_repository: "deb http://oar.imag.fr/debian/2.5 unstable main"
 slurm_repository: "http://downloads.sourceforge.net/project/slurm/under_development"
 slurm_version: "slurm-2.2.0-0.pre12"
 esp_repository: "http://oar.imag.fr/third_part/esp"
 esp_version: "esp-2.2.1"
 #
 # Xionee specific
 cmdctrl_repository: "https://scm.gforge.inria.fr/svn/cmdctrl"
 rctrl_repository: "https://scm.gforge.inria.fr/svn/rctrl"
 xionee_repository: "https://scm.gforge.inria.fr/svn/xionee"
 # 
steps:
 - debian_check_deps
 - check_deps:
   - rsync
   - building_appliance
   - building_kvm_images
# - checkpoint_resume
 - bootstrap
 - system_config
## - network_config_static
 - root_passwd
 - mount_proc
 - software_install:
   - extra_packages
 - kernel_install:
   - kernel-img_conf
 - lustre_kernel_install
 - lustre_g5kutils_install
# - checkpoint
## - breakpoint
 - oar/oar_debian_install
 - oar/oar_system_config
 - oar/oar_config:
   - config_mysql
   - config_taktuk
   - config_cpuset
   - oar_init
 - oar/oar_devel
 - oar/oar_clean
 - slurm/slurm_install:
   - create_munge_key
   - slurm_install
   - write_conf_file
 - esp/esp_install
 ##- esp/create_oar_pm
 ##- esp/create_slurm_pm
 - xionee/xionee_install
 - autologin
 - strip
 - checkpoint
 - umount_proc
## - xen_domu
 - build_appliance:
   - clean_udev
##   - save_as_tgz
   - create_raw_image
   - create_nbd_device
   - mkfs
   - mount_image
   - copy_system_tree
##   - grub_197_workaround
   - install_grub
   - umount_image
   - save_as_raw
##   - save_as_vmdk
##   - save_as_qcow2
##   - save_as_vdi
##   - save_as_iso
 - save_as_g5k
 - clean

