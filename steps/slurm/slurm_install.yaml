slurm_install:
 - install_deps:
   - exec_chroot: bash -c "DEBIAN_FRONTEND=noninteractive apt-get update"
   - exec_chroot: bash -c "DEBIAN_FRONTEND=noninteractive apt-get -y --force-yes install build-essential libreadline6-dev gcc python gawk mysql-server mysql-client libmysqld-dev munge libmunge2 libmunge-dev"
 - create_munge_key:
   - exec_chroot: /usr/sbin/create-munge-key
 - slurm_install:
   - exec_chroot: bash -c "cd /root/ ; wget $$slurm_repository/$$slurm_version.tar.bz2"
   - exec_chroot: bash -c "cd /root/ ; tar xvjf $$slurm_version.tar.bz2 -C ."
   - exec_chroot: bash -c "cd /root/$$slurm_version/ ; ./configure --enable-multiple-slurmd"
   - exec_chroot: bash -c "cd /root/$$slurm_version/ ; make"
   - exec_chroot: bash -c "cd /root/$$slurm_version/ ; make install"
   - exec_chroot: mkdir /home/slurm
   - exec_chroot: useradd slurm
   - exec_chroot: usermod -p \$1\$KkIWr.cK\$cue3GT8UYBVfEVIvMCBLF0 slurm
   - exec_chroot: mkdir /etc/slurm-llnl
   - exec_chroot: mkdir /var/log/slurm
 - write_conf_file:
   - exec_current: cp $$include_dir/etc/slurm-llnl/slurm.conf  $$chroot/etc/slurm-llnl/slurm.conf
   - exec_chroot: bash -c "ln -s /etc/slurm-llnl/slurm.conf /usr/local/etc/slurm.conf"
 - write_dbd_conf_file:
   - exec_current: cp $$include_dir/etc/slurm-llnl/slurmdbd.conf  $$chroot/etc/slurm-llnl/slurmdbd.conf  
   - exec_chroot: bash -c "ln -s /etc/slurm-llnl/slurmdbd.conf /usr/local/etc/slurmdbd.conf"
 - init_dbd:
   - write_file:
     - /etc/slurm-llnl/grant_dbd.sql
     - |
       grant all on slurm_acct_db.* TO 'slurm'@'localhost' identified by 'slurm' with grant option;  
   - exec_chroot: /etc/init.d/mysql start ; mysql -p'kameleon' < /etc/slurm-llnl/grant_dbd.sql ; /etc/init.d/mysql stop
 - create_resources:
   - append_file:
     - /etc/slurm-llnl/slurm.conf
     - |
       #NodeName=$$network_hostname Procs=2 RealMemory=2000 Sockets=1 CoresPerSocket=2 ThreadsPerCore=1 State=IDLE
       #PartitionName=local Priority=1 Nodes=$$network_hostname Default=YES MaxTime=INFINITE State=UP
       NodeName=node1 NodeHostname=node1  Port=17001
       NodeName=node2 NodeHostname=node2  Port=17002
       PartitionName=test Priority=1 Nodes=node1,node2 Default=YES MaxTime=INFINITE State=UP
 - add_init_script_with_resources:
   - write_file:
     - /etc/init.d/slurm-server-conf
     - |       
       #! /bin/sh
       # Default-Start:    5
       # Default-Stop:     0 1 6
       case \"\$1\" in
         start)
           mkdir /dev/cpuset
           mount -t cpuset none /dev/cpuset 
           /usr/local/bin/scontrol update NodeName=$$network_hostname State=IDLE
           /usr/local/sbin/slurmctld
           /usr/local/sbin/slurmd -N node1
           /usr/local/sbin/slurmd -N node2
           ;;
         stop)
           ;;
         *)
           exit 1
           ;;
       esac
       exit 0
   - exec_chroot: chmod +x /etc/init.d/slurm-server-conf
   - exec_chroot: update-rc.d slurm-server-conf defaults
