slurm_install:
 - create_munge_key:
   - exec_chroot: /usr/sbin/create-munge-key
 - slurm_install:
   #- exec_chroot: apt-get update
   #- exec_chroot: apt-get -f install -y --force-yes build-essential libreadline6-dev gcc python gawk
   - exec_chroot: wget $$slurm_repository/$$slurm_version.tar.bz2
   - exec_chroot: tar xvjf $$slurm_version.tar.bz2 -C .
   - exec_chroot: bash -c "cd /$$slurm_version/ ; ./configure --enable-multiple-slurmd"
   - exec_chroot: bash -c "cd /$$slurm_version/ ; make"
   - exec_chroot: bash -c "cd /$$slurm_version/ ; make install"
   - exec_chroot: useradd slurm
   - exec_chroot: usermod -p \$1\$KkIWr.cK\$cue3GT8UYBVfEVIvMCBLF0 slurm
   - exec_chroot: mkdir /etc/slurm-llnl
   - exec_chroot: mkdir /var/log/slurm
   - exec_chroot: touch /etc/slurm-llnl/slurm.conf
   - exec_chroot: bash -c "ln -s /etc/slurm-llnl/slurm.conf /usr/local/etc/slurm.conf"
 - write_conf_file:
   - write_file:
     - /etc/slurm-llnl/slurm.conf
     - |
       # slurm.conf file generated by configurator.html.
       # Put this file on all nodes of your cluster.
       # See the slurm.conf man page for more information.
       #
       ControlMachine=localhost
       #ControlAddr=
       #BackupController=
       #BackupAddr=
       #
       AuthType=auth/munge
       CacheGroups=0
       #CheckpointType=checkpoint/none
       CryptoType=crypto/munge
       #DisableRootJobs=NO
       #EnforcePartLimits=NO
       #Epilog=
       #PrologSlurmctld=
       #FirstJobId=1
       #JobCheckpointDir=/var/slurm/checkpoint
       #JobCredentialPrivateKey=
       #JobCredentialPublicCertificate=
       #JobFileAppend=0
       #JobRequeue=1
       #KillOnBadExit=0
       #Licenses=foo*4,bar
       #MailProg=/bin/mail
       #MaxJobCount=5000
       MpiDefault=none
       #MpiParams=ports:#-#
       #PluginDir=
       #PlugStackConfig=
       #PrivateData=jobs
       ProctrackType=proctrack/linuxproc
       #Prolog=
       #PrologSlurmctld=
       #PropagatePrioProcess=0
       #PropagateResourceLimits=
       #PropagateResourceLimitsExcept=
       ReturnToService=1
       #SallocDefaultCommand=
       SlurmctldPidFile=/var/run/slurmctld.pid
       SlurmctldPort=6817
       #SlurmdPidFile=/var/run/slurmd.pid
       SlurmdPort=6818
       #SlurmdSpoolDir=/tmp/slurmd
       SlurmUser=slurm
       #SrunEpilog=
       #SrunProlog=
       StateSaveLocation=/tmp
       SwitchType=switch/none
       #TaskEpilog=
       TaskPlugin=task/affinity
       TaskPluginParam=Cpusets
       #TaskProlog=
       #TopologyPlugin=topology/tree
       #TmpFs=/tmp
       #TrackWCKey=no
       #TreeWidth=
       #UnkillableStepProgram=
       #UnkillableStepTimeout=
       #UsePAM=1
       #
       #
       # TIMERS
       #BatchStartTimeout=10
       #CompleteWait=0
       #EpilogMsgTime=2000
       #GetEnvTimeout=2
       #HealthCheckInterval=0
       #HealthCheckProgram=
       InactiveLimit=0
       KillWait=30
       #MessageTimeout=10
       #ResvOverRun=0
       MinJobAge=300
       #OverTimeLimit=0
       SlurmctldTimeout=300
       SlurmdTimeout=300
       #UnkillableStepProgram=
       #UnkillableStepTimeout=60
       Waittime=0
       #
       #
       # SCHEDULING
       #DefMemPerCPU=0
       FastSchedule=1
       #MaxMemPerCPU=0
       #SchedulerRootFilter=1
       #SchedulerTimeSlice=30
       #PreemptMode=SUSPEND,GANG
       #PreemptType=preempt/partition_prio
       SchedulerType=sched/backfill
       SchedulerPort=7321
       SelectType=select/cons_res
       SelectTypeParameters=CR_Core_Memory
       #
       #
       # JOB PRIORITY
       #PriorityType=priority/basic
       #PriorityDecayHalfLife=
       #PriorityFavorSmall=
       #PriorityMaxAge=
       #PriorityUsageResetPeriod=
       #PriorityWeightAge=
       #PriorityWeightFairshare=
       #PriorityWeightJobSize=
       #PriorityWeightPartition=
       #PriorityWeightQOS=
       #
       #
       # LOGGING AND ACCOUNTING
       #AccountingStorageEnforce=0
       #AccountingStorageHost=localhost
       #AccountingStorageLoc=slurmDB
       #AccountingStoragePass=slurm
       #AccountingStoragePort=7902
       #AccountingStorageType=accounting_storage/slurmdbd
       #AccountingStorageUser=slurm
       #ClusterName=snowflake
       #DebugFlags=
       #JobCompHost=localhost
       #JobCompLoc=slurm_jobcomp_db
       #JobCompPass=slurm
       #JobCompPort=3306
       #JobCompType=jobcomp/mysql
       #JobCompUser=slurm
       #JobAcctGatherFrequency=30
       JobAcctGatherType=jobacct_gather/linux
       SlurmctldDebug=9
       SlurmctldLogFile=/var/log/slurmctldlog
       SlurmdDebug=9
       #SlurmdLogFile=/var/log/slurmdlog-%h

       ##### Multi daemon
       SlurmdLogFile=/var/log/slurm/slurmd.%n.log
       SlurmdPidFile=/var/run/slurmd.%n.pid
       SlurmdSpoolDir=/var/spool/slurmd.%n
       #####

       #
       #
       # POWER SAVE SUPPORT FOR IDLE NODES (optional)
       #SuspendProgram=/home/g5k/slurm_poweroff
       #ResumeProgram=/home/g5k/slurm_wakeup
       #SuspendProgram=
       #ResumeProgram=
       #SuspendTimeout=
       #ResumeTimeout=
       #ResumeRate=
       #SuspendExcNodes=
       #SuspendExcParts=
       #SuspendRate=
       #SuspendTime=600
       #
       #
       # COMPUTE NODES     
 - create_resources:
   - append_file:
     - /etc/slurm-llnl/slurm.conf
     - |
       #NodeName=$$network_hostname Procs=2 RealMemory=2000 Sockets=1 CoresPerSocket=2 ThreadsPerCore=1 State=IDLE
       #PartitionName=local Priority=1 Nodes=$$network_hostname Default=YES MaxTime=INFINITE State=UP
       NodeName=node1 NodeHostname=node1  Port=17001
       NodeName=node2 NodeHostname=node2  Port=17002
       PartitionName=test Priority=1 Nodes=node1,node2 Default=YES MaxTime=INFINITE State=UP
 - add_init_script_with_resources:
   - write_file:
     - /etc/init.d/slurm-server-conf
     - |       
       #! /bin/sh
       # Default-Start:    5
       # Default-Stop:     0 1 6
       case \"\$1\" in
         start)
           mkdir /dev/cpuset
           mount -t cpuset none /dev/cpuset 
           /usr/local/bin/scontrol update NodeName=$$network_hostname State=IDLE
           /usr/local/sbin/slurmctld
           /usr/local/sbin/slurmd -N node1
           /usr/local/sbin/slurmd -N node2
           ;;
         stop)
           ;;
         *)
           exit 1
           ;;
       esac
       exit 0
   - exec_chroot: chmod +x /etc/init.d/slurm-server-conf
   - exec_chroot: update-rc.d slurm-server-conf defaults

