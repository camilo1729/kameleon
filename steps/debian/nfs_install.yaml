nfs_install:
 - force_new_conf_dpkg:
   - write_file:
     - /etc/apt/apt.conf.d/local-dpkg_force-confnew
     - |
       DPkg::Options {"--force-confnew";};
 - install_nfs_packages:
   - exec_chroot: bash -c "DEBIAN_FRONTEND=noninteractive apt-get update"
   - exec_chroot: bash -c "DEBIAN_FRONTEND=noninteractive apt-get -y --force-yes install nfs-kernel-server nfs-common"
 - write_nfs_server_init:
   - write_file:
     - /usr/sbin/nfs_server_init
     - |
       #!/bin/bash
       set -e
       #TMP_PART=\`df /tmp|tail -1|awk '{print \$1}'\`
       #bash -c \"DEBIAN_FRONTEND=noninteractive apt-get update\"
       #bash -c \"DEBIAN_FRONTEND=noninteractive apt-get -y --force-yes install nfs-kernel-server nfs-common\"
       TMP_PART=$$nfs_partition
       umount \$TMP_PART || true
       pvcreate \$TMP_PART || true
       vgcreate vg00 \$TMP_PART || true
       lvcreate --name vg00/nfs --size $$nfs_partition_size
       mkfs.ext3 /dev/vg00/nfs
       mkdir /nfs
       mount /dev/vg00/nfs /nfs
       chmod 777 /nfs
       echo \"/nfs *(rw,sync)\" >> /etc/exports
       /etc/init.d/nfs-kernel-server restart
   - exec_chroot: chmod +x /usr/sbin/nfs_server_init
 - write_nfs_client_init:
   - write_file:
     - /usr/sbin/nfs_client_init
     - |
       #!/bin/bash
       set -e
       if [ \"\$1\" = \"\" ]
       then
         echo \"usage: nfs_client_init server\"
         exit 1
       fi
       #bash -c \"DEBIAN_FRONTEND=noninteractive apt-get update\"
       #bash -c \"DEBIAN_FRONTEND=noninteractive apt-get -y --force-yes install nfs-common\"
       mkdir /mnt/nfs
       mount \$1:/nfs /mnt/nfs
   - exec_chroot: chmod +x /usr/sbin/nfs_client_init
