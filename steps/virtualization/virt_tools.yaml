virt_tools:
 - install_virt_tools_kvm:
   - exec_chroot: bash -c "DEBIAN_FRONTEND=noninteractive apt-get update"
   - exec_chroot: bash -c "DEBIAN_FRONTEND=noninteractive apt-get -y --force-yes install kvm libvirt-bin uml-utilities"
 - create_random_mac_generator_script:
   - write_file:
     - /usr/bin/random_mac.sh
     - |
       #!/bin/bash
       perl -e 'printf \"00:16:3E:%02X:%02X:%02X\\n\", rand 0xFF, rand 0xFF, rand 0xFF'
   - exec_chroot: chmod +x /usr/bin/random_mac.sh
 - create_bridge_creation_script:
   - write_file:
     - /usr/bin/create_bridge.sh
     - |
       #!/bin/bash
       set -e
       INTERFACE=\$1
       if [ -z \"\$INTERFACE\" ]
       then
         INTERFACE=\"eth0\"
       fi
       BRIDGE=\$2
       if [ -z \"\$BRIDGE\" ]
       then
         BRIDGE=\"br0\"
       fi
       cat >> /etc/network/interfaces <<EOF

       auto \$BRIDGE
       iface \$BRIDGE inet dhcp
         bridge_ports \$INTERFACE
         bridge_stp off
         bridge_maxwait 0
         bridge_fd 0
       EOF
       /etc/init.d/networking restart
       TAPDEV=\`/usr/sbin/tunctl -b\`
       brctl addif \$BRIDGE \$TAPDEV
       ip link set $TAPDEV up
   - exec_chroot: chmod +x /usr/bin/create_bridge.sh
